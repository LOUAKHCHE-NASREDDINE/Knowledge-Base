### Detailed Guide: Using **Certbot** and **Let's Encrypt** to Secure Your Nginx Website on AWS EC2

This guide will help you secure your **Nginx** server on an **AWS EC2 instance** with an SSL certificate from **Let's Encrypt** using **Certbot**. Unlike self-signed certificates, certificates from Let's Encrypt are trusted by browsers, and Certbot automates the process of generating and renewing certificates.

We'll cover:
1. **Installing Certbot** on the EC2 instance.
2. **Generating and applying SSL certificates** for your domain.
3. **Setting up automatic certificate renewal**.
4. **Connecting the certificate to your AWS Application Load Balancer (ALB)**.
5. **Where the certificate files are saved**.

---

### **Step-by-Step Guide**

---

### **Step 1: SSH into the EC2 Instance**

First, connect to your **EC2 instance** running Nginx using SSH.

```bash
ssh -i /path/to/your/key.pem ec2-user@your-instance-public-ip
```

Make sure that your EC2 instance has an elastic IP or a static IP for domain binding.

---

### **Step 2: Install Certbot and Dependencies**

Certbot automates the process of getting SSL certificates. We will install Certbot within a **Python virtual environment**.

#### **For Ubuntu/Debian-based systems**:

1. **Update the system**:
   ```bash
   sudo apt update
   ```

2. **Install required dependencies**:
   ```bash
   sudo apt install python3 python3-venv libaugeas0 -y
   ```

#### **For Amazon Linux 2/CentOS-based systems**:

1. **Install dependencies**:
   ```bash
   sudo yum install python3 augeas-libs
   ```

2. **Set up a Python virtual environment for Certbot**:
   ```bash
   sudo python3 -m venv /opt/certbot/
   sudo /opt/certbot/bin/pip install --upgrade pip
   ```

3. **Install Certbot**:
   ```bash
   sudo /opt/certbot/bin/pip install certbot certbot-nginx
   ```

4. **Link Certbot to the system path**:
   ```bash
   sudo ln -s /opt/certbot/bin/certbot /usr/bin/certbot 
   ```

---

### **Step 3: Generate SSL Certificate for Nginx**

Certbot can automatically fetch an SSL certificate for your domain and configure Nginx to serve the site over HTTPS.

1. **Run Certbot for Nginx**:
   ```bash
   sudo certbot --nginx
   ```

2. **Follow the prompts**:
   Certbot will ask for your **domain name**. Enter your domain (e.g., `matan-moshe.online`).

Certbot will:
- Verify domain ownership by using Nginx as a web server.
- Automatically configure Nginx to use the generated SSL certificate.
- Set up your server to serve HTTPS traffic.

---

### **Step 4: Set Up Automatic Renewal**

Let's Encrypt certificates are only valid for **90 days**, so setting up automatic renewal is critical.

1. **Set up a cron job** to check for certificate renewal twice a day:
   ```bash
   echo "0 0,12 * * * root /opt/certbot/bin/python -c 'import random; import time; time.sleep(random.random() * 3600)' && sudo certbot renew -q" | sudo tee -a /etc/crontab > /dev/null
   ```

This ensures that your certificates will automatically renew before they expire.

---

### **Step 5: Connect the Certificate to Your AWS Application Load Balancer (ALB)**

If you are using an ALB (Application Load Balancer) to manage traffic across multiple EC2 instances, you need to upload the SSL certificate to **AWS ACM** (AWS Certificate Manager) and attach it to your ALB.

#### **5.1. Locate the Certbot Certificate Files**

The certificate files generated by Certbot are stored in the following locations:

- **Fullchain certificate**: `/etc/letsencrypt/live/your-domain/fullchain.pem`
- **Private key**: `/etc/letsencrypt/live/your-domain/privkey.pem`

For example, for the domain `matan-moshe.online`, the paths will be:
- `/etc/letsencrypt/live/matan-moshe.online/fullchain.pem`
- `/etc/letsencrypt/live/matan-moshe.online/privkey.pem`

#### **5.2. Upload the Certificate to AWS ACM**

1. Go to **AWS Certificate Manager (ACM)** in the AWS Console.
2. Click **Import a certificate**.
3. Upload the following:
   - **Certificate body**: Paste the contents of `fullchain.pem`.
   - **Private key**: Paste the contents of `privkey.pem`.
   - Leave the **Certificate chain** field empty.

#### **5.3. Attach the SSL Certificate to Your ALB**

1. Go to the **EC2 Console** > **Load Balancers**.
2. Select your ALB (`webserver-alb-285395319.us-east-1.elb.amazonaws.com`).
3. Under the **Listeners** tab, edit the **HTTPS listener** and attach the newly uploaded ACM certificate.
4. Save the configuration.

---

### **Step 6: Update DNS Settings in Route 53**

After setting up SSL on the ALB, you need to update your **Route 53** DNS settings to point your domain to the ALB.

1. Go to **Route 53** in the AWS Console.
2. Select your domain's hosted zone.
3. Add or update the **A record** (Alias) to point to your ALB DNS name (`webserver-alb-285395319.us-east-1.elb.amazonaws.com`).
4. Wait for the DNS propagation (this can take a few minutes).

---

### **Where Certbot Saves Certificate Files**

Certbot saves the certificate files in `/etc/letsencrypt/live/your-domain/`. These files include:

- **`fullchain.pem`**: The full certificate chain (your certificate and any intermediates).
- **`privkey.pem`**: The private key associated with your certificate.

You can list these files using:

```bash
sudo ls -l /etc/letsencrypt/live/matan-moshe.online/
```

You will see:
- `cert.pem` (your certificate)
- `privkey.pem` (private key)
- `fullchain.pem` (full certificate chain)
- `chain.pem` (optional, intermediate certificate)

---

### **Step 7: Verify the Setup**

1. **Open your browser** and visit `https://matan-moshe.online`.
2. Look for the **lock icon** in the address bar, indicating the site is served over HTTPS and the certificate is valid.
3. You can check the details of the certificate by clicking on the lock icon.

---

### **Optional: Monthly Upgrade Certbot**

It's important to occasionally update Certbot to ensure you are running the latest version. Run this command:

```bash
sudo /opt/certbot/bin/pip install --upgrade certbot certbot-nginx
```

---

### **Summary**

1. **Install Certbot**: Set up Certbot on your EC2 instance to manage SSL certificates.
2. **Generate SSL Certificates**: Use Certbot to generate and configure SSL certificates for Nginx.
3. **Automatic Renewal**: Ensure automatic renewal of Let's Encrypt certificates using a cron job.
4. **Upload to AWS ACM**: Upload the certificate to AWS ACM and attach it to your ALB.
5. **Update Route 53**: Point your domain to the ALB to serve traffic securely via HTTPS.

By following this guide, you can easily use Let's Encrypt SSL certificates to secure your Nginx web server on AWS and ensure your site runs securely without browser warnings.